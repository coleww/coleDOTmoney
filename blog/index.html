<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cole Codes Cool Code</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/blog/stylesheets/main.css" rel="stylesheet" type="text/css" />
    <meta name="description" content="Making art with code and vice versa." />
<meta name="keywords" content="ruby, javascript, code, art" />
  </head>
  <body>
    <center>
<a href="/blog">        <img class="header" src="/blog/images/cool.png" />
</a>    </center>

    <div id="main" role="main">
        <h2><a href="/blog/npm-cli.html">Building a *nice* CLI For Your Sick npm Module</a> <span>Jul 16</span></h2>
  <!-- <h1>Building a <em>nice</em> CLI For Your Sick npm Module</h1>

<h2>A tale in backticks</h2>

<p>Ok so you have written a pretty sweet node module. <em>nice</em>. Ok so maybe you want to make this utility available on the command line?</p>

<p><code>touch cmd.js</code> lets make a file!</p>

<p><code>chmod +x cmd.js</code> lets make it executable!</p>

<p><code>./cmd.js</code> doesnt do anything yet!</p>

<p>But hey, it ran on the command line!</p>

<p>THE END</p>

<p>Ok so open up cmd.js in the text editor of yr choosing and add:</p>

<p><code>#!/usr/bin/env node</code> This tells computer how to run this script
<code>var yrModule = require(&#39;./&#39;)</code> Load up that code</p>

<p>But wait! What about arguments! I have a lot to say!</p>

<p>shhhh go back to the command line:</p>

<p><code>npm install yargs --save</code> <a href="https://www.npmjs.com/package/yargs">yargs</a> is pretty cool. <a href="https://www.npmjs.com/package/minimist">minimist</a> is also pretty cool. I ended up using yargs due to reasons that I cannot recall. Cool story.</p>

<p>Go back to the text editor and add:</p>
<pre class="highlight plaintext"><code>var argv = require('yargs')
  .alias('h', 'help')
  .help('help')
  .usage('what does thing do?')
  .example('yrModule POTATOES!')
  .alias('i', 'intensity')
  .describe('i', 'describe what the arguments do')
  .argv
</code></pre>

<p>Of course&hellip;you should probably edit things to suit yr module. You can chain multiple example/alias/describe calls if you want to show off more functionality or define other options.</p>

<p><code>./cmd.js -h</code> =&gt; automatic documentation!</p>

<p>Once defined, yargs literally does not care how things are passed to it.</p>

<p><code>./cmd.js -i 72 what is up with airline food?</code> ALL GOOD!
<code>./cmd.js what is up with airline food? --intensity=72</code> TOTALLY COOL! SAME THING!</p>

<p>In either case, inside the running cmd.js script the following would be the truth:</p>

<p><code>argv._</code> =&gt; [&lsquo;what&rsquo;, &#39;is&rsquo;, &#39;up&rsquo;, &#39;with&rsquo;, &#39;airline&rsquo;, &#39;food?&rsquo;]
<code>argv.i</code> =&gt; 72</p>

<p>If your module is simple enough, you might be done! Back to the text editor!</p>

<p><code>var output = yrModule(argv._.join(&quot; &quot;), argv.i)</code> pass the arguments to yrModule (maybe it responds to jokes?)
<code>process.stdout.write(output)</code> write the output to the terminal
<code>process.exit()</code> exit the program</p>

<p>The UNIX ideology believes that building simple interfaces that accept text input and produce text output are super radical. We are fulfilling that dream right now. To the command line:</p>

<p><code>./cmd.js -i 12 awwwwoooooooooooooooooo | grep whales &gt;&gt; save_them.txt</code> Amazing.</p>

<p>Well, I don&rsquo;t know if yr module has anything to do with whales, but it probably should.</p>

<p>But hey! <code>grep</code> accepts that weird <code>|</code> pipe thing! Can we accept the weird pipe thing and thus complete our embodiment of the UNIX philosophy?</p>

<p>Yes. Sure. Lets edit some text.</p>

<p>First we wrap our original non-pipey code with an if block:</p>
<pre class="highlight plaintext"><code>if(process.stdin.isTTY) {
  var output = yrModule(argv._.join(" "), argv.i)
  process.stdout.write(output)
  process.exit()
</code></pre>

<p><code>process.stdin.isTTY</code> basically asks node &ldquo;IS THIS A TERMINAL?&rdquo;</p>

<p>And then the else case, for pipey-times:</p>
<pre class="highlight plaintext"><code>} else {
  var data = ''
  process.stdin.resume()
  process.stdin.setEncoding('utf8')
  process.stdin.on('data', function(chunk) {
    data += chunk
  })

  process.stdin.on('end', function() {
    process.stdout.write(yrModule(data, argv.i))
    process.exit()
  })
}
</code></pre>

<p><code>cat burrito_recipes.txt | ./cmd.js -i 400</code> WOW all kinds of inputs</p>

<p>If your module is super complex and might be used on datasets that can&rsquo;t be stored in RAM then you should probably stream the chunks directly into your codes rather than building up a data string and doing it all at once. But this is fine, it&rsquo;s fine, probably fine. Totally.</p>

<p>Cool! Now your module is ready to do all sorts of command line tricks. The last thing you need to remember to do before publishing this update to npm is adding a &ldquo;bin&rdquo; entry to your package.json file so that yr CLI script is available in the PATH of those who install your module. (But if you forget sometimes don&rsquo;t worry about dat inevitable post-npm-publish-version-bump-re-publish it happens to the best of us.)</p>
<pre class="highlight plaintext"><code>"bin": {
    "yrModule": "cmd.js"
},
</code></pre>

<p>Of course replace yrModule with whatever you want the command line executable to be. In this instance you could do:</p>

<p><code>yrModule foo fighters -i 65</code> probably make sure you pick a name that isn&rsquo;t already a thing, like <code>git</code>, that would be bad. </p>

<p>ONE LAST THING!</p>

<p><code>process.exit(1)</code> handle yr errors! If yr CLI script fails for some reason, exit with a 1 so that computer knows that a bad thing happened.</p>

<hr>

<p><code>npm publish</code> YOU ARE A HERO</p>

<p>You can see this sort of thing in action in this <a href="https://github.com/coleww/diacriticize/blob/gh-pages/cmd.js">cmd.js example code from one of my modules</a> as well as this <a href="https://github.com/coleww/mkproj/blob/master/cmd.js">wow, absolute bare minimum here, doesn&rsquo;t even take arguments, barely trying, cool</a></p>
 -->
  <h2><a href="/blog/shelling-out.html">shelling out to the system</a> <span>Jul 10</span></h2>
  <!-- <h1>Shelling Out</h1>

<h2>I would gladly shell out 5$ for you to pipe a burrito to me, streaming, over the course of the next 7 minutes.</h2>

<p>Traditionally in UNIX land one would connect the output of various programs to the inputs of others with pipes (<code>|</code>) directly on the command line, or within the depths of a shell script, like so:</p>

<p><code>cat recipe.txt | grep potatoes &gt;&gt; potato_ideas.txt</code></p>

<p>This is a great way to compose complex actions out of many small utilities.</p>

<p><img alt="pipe" src="/blog/images/pipe.png" /></p>

<p>Piping works fine for non-interactive programs that are all text-in/text-out, and you can certainly write bash scripts that <code>touch</code> and <code>mkdir</code> your way to many victories, but what about integrating more complicated CLI tools like npm, bower, ember, rails, or git? These programs do things like prompt the user to make decisions, hit the network, or generate a metric ton of files, and it might get unwieldy to try to control such chaos directly from the command line. Instead, you can write a script that shells out to them!</p>

<p><img alt="shelling" src="/blog/images/shelling.png" /></p>

<p>In Ruby, the easiest way to shell out a command is to put it backticks, like so:</p>
<pre class="highlight ruby"><code><span class="c1"># this would print the current directory</span>
<span class="nb">puts</span> <span class="sb">`ls`</span>
</code></pre>

<p>The same shelling, but with Node.js:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">exec</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'child_process'</span><span class="p">).</span><span class="nx">exec</span>
<span class="nx">exec</span><span class="p">(</span><span class="s1">'ls'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// this would print the current directory</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stdout</span><span class="p">)</span>

  <span class="c1">// probably some callback hell here</span>
<span class="p">});</span>
</code></pre>

<p>With these, you can easily run shell commands and respond to their output as part of your script. But what if instead of just running a command you want to turn over control to a different program? Maybe that program has user prompts that need answering or it shows some pretty sweet terminal graphics.</p>

<p>In Ruby you can use <code>exec</code>, which replaces the current process with the given command:</p>
<pre class="highlight ruby"><code><span class="nb">exec</span> <span class="s2">"rails new monolith"</span>
<span class="nb">puts</span> <span class="s2">"never gets here cuz rails takes over"</span>
</code></pre>

<p>In Node.js there is the <a href="https://www.npmjs.com/package/kexec">kexec</a> module, which does the exact same thing:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">kexec</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'kexec'</span><span class="p">)</span>
<span class="nx">kexec</span><span class="p">(</span><span class="s1">'ember new behemoth'</span><span class="p">)</span>
</code></pre>

<p>I used some of these magical spells to build <a href="https://github.com/coleww/mkproj">mkproj</a>, which generates a bunch of files and does some NPM stuff in order to scaffold lil browserify projects. Being able to run code on the command line from a Ruby or Node script opens up tons of possibilities for destroying your computer in a for loop! Reader beware!</p>
 -->
  <h2><a href="/blog/do-cron.html">automating bots with cron on digital ocean</a> <span>Jun 23</span></h2>
  <!-- <h1>automating bots with cron on digital ocean</h1>

<h2>because setInterval is probably not the right thing to do</h2>

<p>I used to deploy all my bots to Heroku, running in constant loops on those sweet sweet free single dynos.</p>

<p>They looked something like this:</p>
<pre class="highlight ruby"><code>    <span class="kp">loop</span> <span class="k">do</span>
        <span class="c1"># do some stuff</span>
        <span class="no">BOT</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">funny_tweet_lol</span><span class="p">)</span>
        <span class="nb">sleep</span> <span class="mi">10800</span> <span class="o">+</span> <span class="p">(</span><span class="nb">rand</span> <span class="mi">5400</span><span class="p">)</span>
    <span class="k">end</span>
</code></pre>

<p>This is&hellip;not optimal for a number of reasons. But since I could create new Heroku apps for free from the command line it was super easy, and, well, why not. I even made a <a href="https://github.com/coleww/twitter_bot_generator">twitter bot generator ruby gem</a> around the concept. Don&rsquo;t judge me.</p>

<p>With deng near fifty of these things running, I was not much pleased to hear about the new Heroku pricing plan. Though of course I couldn&rsquo;t get mad cuz it was free servers in the first place. While I could have meticulously gone through all my Heroku apps and updated them to not loop/sleep forever and instead scheduled the scripts to run at various intervals, I figured it was finally time to get close to that cloud server metal and put together a lil droplet for myself in the Digital Ocean.</p>

<p>There are many tutorials on setting up virtual servers, but I found that the biggest pain point in the process was getting my scripts to run on a schedule with cron.  It turns out that cron jobs are run with a very minimal environment setup, for reasons that I guess are cool. You can look up why but honestly it&rsquo;s totally boring.</p>

<p><img alt="corn" src="/blog/images/corn.jpg" /></p>

<ul>
<li>WHY IS THERE NO NODE.JS HERE?!</li>
</ul>

<p>Even though I had installed all the nodes and rubies, my cron seemed to just ignore them. I thought that was quite rude. To fix this, you just need to export your path. Enter <code>echo PATH=$PATH</code> and copy paste the output into your crontab.</p>

<p>This was what I saw:</p>
<pre class="highlight plaintext"><code>root@1404-64:~# echo PATH=$PATH
PATH=/root/.nvm/versions/v0.12.2/bin:/usr/local/rvm/gems/ruby-2.2.1/bin:/usr/local/rvm/gems/ruby-2.2.1@global/bin:/usr/local/rvm/rubies/ruby-2.2.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/local/rvm/bin
</code></pre>

<p>And just dump it in the <code>crontab -e</code> before your job listings.</p>
<pre class="highlight plaintext"><code>#
# For more information see the manual pages of crontab(5) and cron(8)
#
# m h  dom mon dow   command
PATH=/root/.nvm/versions/v0.12.2/bin:/usr/local/rvm/gems/ruby-2.2.1/bin:/usr/local/rvm/gems/ruby-2.2.1@global/bin:/usr/local/rvm/rubies/ruby-2.2.1/bin:/usr$
</code></pre>

<ul>
<li>.././../././relative paths :&lt;</li>
</ul>

<p>Now I had node, but my require(&rsquo;./module&rsquo;) calls didn&rsquo;t seem to work! Cron apparently is not only PATHless but also pathless. My crons looked something like <code>* * * * * node bots/lolbot/bot.js &gt;&gt; ~/lol.log</code> but in order to correctly set my working path, I just had to <code>cd</code> into the parent directory before running the script, like so: <code>* * * * * cd bots/lolbot &amp;&amp; node bot.js &gt;&gt; ~/lol.log</code>.</p>

<hr>

<p>This &ldquo;blog post&rdquo; was <a href="https://twitter.com/colewillsea/lists/my-robots">tested</a> on a 512MB Ram20GB SSD Disk Ubuntu 14.04 x64 Digital Ocean droplet but will probably apply for pretty much any linux-y system anywhere.</p>
 -->
  <h2><a href="/blog/trigger-loading-route-in-ember.html">Manually Trigger Loading Routes in Ember</a> <span>Jun  9</span></h2>
  <!-- <h1>Manually Trigger Loading Routes in Ember</h1>

<h2>cuz Ember can&rsquo;t do  e v e r y t h i n g  for you</h2>

<p>Loading routes in Ember are pretty frigging sweet. You can drop a spinner .gif pretty much any frigging where you want. You can even make nested loading routes: it&rsquo;s frigging awesome.</p>

<p>One trick, however, is making use of those loading routes when persisting customer informatin to your datbase. The loading routes automagically hop into place while you are fetching data, but they can&rsquo;t do the same when saving it. That would be weird and unfortunate.</p>

<p>Instead, you must explicitly tell the router that you are loading some stuff and to just chill the frig out for a second while you figure some things out.</p>

<p>FOR EXAMPLE (presuming you are on the user.edit route, editing yrself):</p>
<pre class="highlight javascript"><code><span class="nx">saveUserInformation</span><span class="p">(){</span>

  <span class="c1">// MANUALLY TRANSITIONING TO THE LOADING ROUTE</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'loading'</span><span class="p">);</span>

  <span class="c1">// return a promise whose `then` and `catch` callbacks each transition to an appropriate route</span>
  <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'user.index'</span><span class="p">);</span>
    <span class="c1">// success! go to the infernal User index and suffer with the rest of them!</span>

  <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// do something to User with the `e` errors --&gt; very bad... show warning/</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'user.edit'</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
    <span class="c1">// return to the current page, with the current model data all still set like WOWWW</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>

<p>A N D   T H A T S    I T</p>

<p>Just a simple <code>this.transitionTo(&#39;loading&#39;)</code> and you can punt the Ember route back into loading mode. Try it today!</p>
 -->
  <h2><a href="/blog/eating-glue-and-paste.html">Eating Glue</a> <span>Jun  3</span></h2>
  <!-- <h1>EATING GLUE</h1>

<h2>Taking Over the Paste Event</h2>

<p>Though they started out as simple document viewers, over the years web browsers have escaped from their sandbox and gained more and more access to operating system level goodness, like your camera and GPS coordinates. This level of intrusivenes used to only be possible for those with the skills and courage to wield awkward Flash hacks, but today this sort of stuff is made available through simple JavaScript APIs to every website you visit. <em>Awesome.</em></p>

<p><img alt="Ralph likes to hack JavaScript" src="/blog/images/paste.jpg" /></p>

<p>One basic computer technology that we can hijack and manipulate however we please is pasting. Some people think it&rsquo;s wrong to mess with fundamental UI behavior like clicking or scrolling or, I suppose, <code>ctrl+v</code>, but I say SHOW ME THE CODE:</p>
<pre class="highlight javascript"><code>    <span class="c1">// take over any paste event that occurs on this page</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'paste'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clipboardData</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="s1">'text/plain'</span><span class="p">)</span>

      <span class="nx">alert</span><span class="p">(</span><span class="s1">'YOU TRIED TO PASTE '</span> <span class="o">+</span> <span class="nx">data</span> <span class="o">+</span> <span class="s1">', TOO BAD.'</span><span class="p">)</span>

      <span class="k">return</span> <span class="kc">false</span> <span class="c1">// don't let the normal "paste" event happen</span>
    <span class="p">})</span>
</code></pre>

<p>And that&rsquo;s it!</p>

<p><a href="http://stackoverflow.com/questions/6035071/intercept-paste-event-in-javascript">According to my in depth research into this subject</a> you need to use <code>window.clipboardData.getData(&#39;Text&#39;)</code> in IE, or <code>e.originalEvent.clipboardData</code> if you install the event handler with something called &ldquo;Jquery&rdquo;.</p>

<h4>ok but why</h4>

<p>I used this trick to build a <a href="http://coleww.github.io/json-formatter/">JSON formatter</a> [<a href="https://github.com/coleww/json-formatter">code</a>] because I wanted to quickly paste a JSON blob to the page and see it transformed, and an input field or textarea would just get in the way of things. Most JSON formatters on the web are laden with options and advertisements, but all I really needed was a quick way to inspect API responses.</p>

<p>By hacking the paste event, I was able to take something that looked like this:</p>

<p><img alt="before" src="/blog/images/json-og.png" /></p>

<p>And make it work more like this:</p>

<p><img alt="after" src="/blog/images/json-example.gif" /></p>

<p>This approach is well aligned with the UNIX philosophy, which holds among it&rsquo;s tenets &ldquo;make small things&rdquo; and &ldquo;text in/text out&rdquo;. Only in this instance, input is handled by the paste event and the output is a div. The web page itself does only one thing and nothing else (literally, there isn&rsquo;t even a title or attribution) which means it composes well with other &ldquo;modules&rdquo; in the browser, like for example using <code>cmd+f</code> to find things in the formatted JSON. And if I needed to add an option for controlling the indentation level or something I could perhaps add it as a query param in the URL.</p>

<p>The JSON formatter is actually just a wrapper around a node module called <a href="https://github.com/JerrySievert/json">json-nice</a>, and there are probably many other small command line tools that could benefit from being turned into tiny web apps. With <a href="https://github.com/substack/browserify-handbook">browserify</a> and <a href="http://maxogden.com/node-packaged-modules.html">npm</a> this becomes really easy.</p>
 -->
<br /><br /><br /><br /><br /><br /><br /><br /><br />

    <p><a href="/blog/page/2/">Next page</a></p>

      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
      <br/>
    </div>

    <aside>
      <p><div id="contact">
        <a href="http://colewillsea.com/">Cole Willsea</a>
        (<a href="https://github.com/coleww">github</a>)
        (<a href="https://twitter.com/colewillsea">twitter</a>)
      </div></p>
      <h2>RECENT BLAGZ</h2>
      <ol>
          <li><a href="/blog/npm-cli.html">Building a *nice* CLI For Your Sick npm Module</a> <span>Jul 16</span></li>
          <li><a href="/blog/shelling-out.html">shelling out to the system</a> <span>Jul 10</span></li>
          <li><a href="/blog/do-cron.html">automating bots with cron on digital ocean</a> <span>Jun 23</span></li>
          <li><a href="/blog/trigger-loading-route-in-ember.html">Manually Trigger Loading Routes in Ember</a> <span>Jun  9</span></li>
          <li><a href="/blog/eating-glue-and-paste.html">Eating Glue</a> <span>Jun  3</span></li>
          <li><a href="/blog/syntax-highlighting-in-middleman.html">100% EZ Syntax Highlighting With Middleman</a> <span>May 30</span></li>
      </ol>

    </aside>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(["_setAccount", "UA-26036675-1"]);
  _gaq.push(["_trackPageview"]);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>
